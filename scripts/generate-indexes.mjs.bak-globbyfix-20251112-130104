// scripts/generate-indexes.mjs
import { promises as fs } from "node:fs";
import path from "node:path";
import globby from "globby";
import { parseDocument } from "htmlparser2";
import slugify from "slugify";
import fg from "fast-glob";


const ROOT = process.cwd();
const POSTS_DIR = path.join(ROOT, "posts");
const PROJECTS_DIR = path.join(ROOT, "projects");

function textOfFirst(el, name) {
  if (!el) return null;
  const stack = [el];
  while (stack.length) {
    const n = stack.shift();
    if (n.name === name && n.children?.[0]?.data) return n.children[0].data.trim();
    if (n.children) stack.push(...n.children);
  }
  return null;
}

function findMeta(doc, metaName) {
  const stack = [doc];
  while (stack.length) {
    const n = stack.shift();
    if (n.name === "meta" && n.attribs && (n.attribs.name === metaName)) {
      return n.attribs.content?.trim() || null;
    }
    if (n.children) stack.push(...n.children);
  }
  return null;
}

async function collectFrom(rootDir, kind) {
  const files = await globby("**/index.html", { cwd: rootDir, dot: false });
  const base = path.relative(ROOT, rootDir).replaceAll("\\", "/");
  const items = [];

  for (const rel of files) {
    const abs = path.join(rootDir, rel);
    const html = await fs.readFile(abs, "utf8");
    const doc = parseDocument(html);

    const title = textOfFirst(doc, "h1") || path.basename(path.dirname(abs));
    const description = findMeta(doc, "description") || "";
    const tags = (findMeta(doc, "tags") || "")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);

    const dirUrl = "/" + path.join(base, path.dirname(rel)).replaceAll("\\", "/");
    items.push({
      title,
      description,
      tags,
      url: dirUrl + "/",
      slug: slugify(title, { lower: true, strict: true }),
      kind
    });
  }

  // newest first by URL path (posts often include y/m in path)
  items.sort((a, b) => a.url < b.url ? 1 : -1);
  return items;
}

async function ensureIndexPage(kind, jsonName, pagePath, heading) {
  // ultra-light listing page that reads the JSON and renders links
  const html = `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>${heading}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;line-height:1.6;margin:2rem;max-width:960px}
    h1{font-size:2rem;margin:0 0 1rem}
    ul{list-style:none;padding:0}
    li{margin:.5rem 0;padding:.75rem 1rem;border:1px solid #e5e7eb;border-radius:.75rem}
    a{font-weight:600;text-decoration:none}
    .tags{font-size:.85rem;color:#555;margin-top:.25rem}
  </style>
</head>
<body>
  <h1>${heading}</h1>
  <ul id="list"></ul>
  <script type="module">
    const res = await fetch('/${jsonName}');
    const data = await res.json();
    const list = document.querySelector('#list');
    data.forEach(x => {
      const li = document.createElement('li');
      li.innerHTML = \`<a href="\${x.url}">\${x.title}</a>\${x.description ? '<div>'+x.description+'</div>' : ''}\${x.tags?.length ? '<div class="tags"># '+x.tags.join(', ')+'</div>' : ''}\`;
      list.appendChild(li);
    });
  </script>
</body>
</html>`;
  await fs.writeFile(pagePath, html, "utf8");
}

async function main() {
  const posts = (await fs.stat(POSTS_DIR).catch(() => null)) ? await collectFrom(POSTS_DIR, "post") : [];
  const projects = (await fs.stat(PROJECTS_DIR).catch(() => null)) ? await collectFrom(PROJECTS_DIR, "project") : [];

  await fs.writeFile(path.join(ROOT, "posts.json"), JSON.stringify(posts, null, 2), "utf8");
  await fs.writeFile(path.join(ROOT, "projects.json"), JSON.stringify(projects, null, 2), "utf8");

  // listing pages
  await ensureIndexPage("post", "posts.json", path.join(ROOT, "blog", "index.html"), "All Blog Posts");
  await ensureIndexPage("project", "projects.json", path.join(ROOT, "projects", "index.html"), "Projects");

  console.log(`\nâœ“ generated ${posts.length} posts and ${projects.length} projects`);
}

await main().catch((e) => { console.error(e); process.exit(1); });

